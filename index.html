<!DOCTYPE html>
<html lang="ht">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>D'H7 | Digital Hub 7</title>
    <meta name="description" content="D'H7 (Digital Hub 7) se yon platfòm kominikasyon sekirize ki pèmèt ou jere idantite dijital ou ak yon TFID/D'H7 inik. Konekte kounye a pou w jwenn aksè nan yon rezo pwoteje, miltiling (Kreyòl, Fransè, Angle, Espanyòl), epi fasil pou itilize.">

    <link rel="icon" type="image/png" href="https://www.adamdh7.org/asset/IMG_7023.png">
    <link rel="shortcut icon" href="https://www.adamdh7.org/asset/IMG_7023.png">
    <link rel="canonical" href="https://www.adamdh7.org/" />
    <link rel="apple-touch-icon" href="https://www.adamdh7.org/asset/IMG_7023.png" />

    <meta property="og:title" content="D'H7 - Digital Hub 7">
    <meta property="og:description" content="Konekte sou D'H7 pou yon eksperyans dijital sekirize.">
    <meta property="og:image" content="https://www.adamdh7.org/asset/IMG_7023.png">
    <meta property="og:url" content="https://www.adamdh7.org">
    <meta property="og:type" content="website">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "D'H7",
      "alternateName": "Digital Hub 7",
      "url": "https://www.adamdh7.org",
      "logo": "https://www.adamdh7.org/asset/IMG_7023.png"
    }
    </script>

    <link rel="manifest" href="manifest.json" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --bg-pure: #000000;
            --bg-card: #0a0a0a;
            --bg-input: #1c1c1e;
            --accent: #007aff;
            --border: #1a1a1a;
            --text-dim: #8e8e93;
            --msg-me: #007aff;
            --msg-them: #262628;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-pure);
            color: white;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
        }

        /* 1. SCROLL PARFAIT (Native iOS feel) */
        .scroll-container {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y pinch-zoom;
            overscroll-behavior-y: contain;
            scroll-behavior: smooth;
        }
        
        .scroll-container::-webkit-scrollbar { width: 0; display: none; }

        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-pure);
            z-index: 10;
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1), opacity 0.2s; /* iOS slide transition */
        }

        .screen.hidden-left { transform: translateX(-30%); opacity: 0; pointer-events: none; } /* Parallax effect */
        .screen.hidden-right { transform: translateX(100%); opacity: 1; pointer-events: none; } /* Slide in from right */
        .screen.active { transform: translateX(0); opacity: 1; pointer-events: auto; }

        .ios-header {
            padding: env(safe-area-inset-top) 1rem 0.8rem 1rem;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
        }

        /* Chat Layout */
        .chat-body {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 2px; /* WhatsApp style gap */
        }

        .bubble {
            max-width: 80%;
            padding: 0.5rem 0.8rem;
            font-size: 1rem;
            line-height: 1.4;
            position: relative;
            white-space: pre-wrap;
            word-break: break-word;
            margin-bottom: 2px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        .bubble.me {
            align-self: flex-end;
            background-color: var(--msg-me);
            color: white;
            border-radius: 12px 12px 0 12px;
        }

        .bubble.them {
            align-self: flex-start;
            background-color: var(--msg-them);
            color: white;
            border-radius: 12px 12px 12px 0;
        }

        /* Media Support Styles */
        .media-content {
            border-radius: 8px;
            overflow: hidden;
            margin-top: 4px;
            margin-bottom: 4px;
            cursor: pointer;
        }
        .media-content img, .media-content video {
            max-width: 100%;
            height: auto;
            display: block;
        }
        .fullscreen-media {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .fullscreen-media img, .fullscreen-media video {
            max-width: 100%;
            max-height: 90%;
            object-fit: contain;
        }
        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            cursor: pointer;
            z-index: 10000;
        }
        .fullscreen-media audio {
            width: 80%;
            margin: 20px auto;
        }

        /* File Link Style */
        .file-link {
            color: #66e0ff;
            text-decoration: underline;
            cursor: pointer;
        }

        /* Reply Styles */
        .reply-bar {
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 4px 8px;
            margin-bottom: 4px;
            font-size: 0.75rem;
            border-left: 3px solid rgba(255,255,255,0.5);
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }
        .reply-name { font-weight: 700; color: rgba(255,255,255,0.9); margin-bottom: 2px; }
        .reply-text { color: rgba(255,255,255,0.7); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .status {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.6);
            display: inline-block;
            float: right;
            margin-left: 8px;
            margin-top: 4px;
        }
        .status.read { color: #66e0ff; }

        /* Input Area - WhatsApp Style */
        .input-area {
            padding: 0.5rem 0.5rem calc(0.5rem + env(safe-area-inset-bottom)) 0.5rem;
            background: var(--bg-pure);
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            border-top: 0.5px solid rgba(255,255,255,0.1);
        }

        .input-wrapper {
            flex: 1;
            background: var(--bg-input);
            border-radius: 20px;
            display: flex;
            align-items: flex-end;
            padding: 8px 12px;
            min-height: 40px;
        }

        #msg-input {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            outline: none;
            font-size: 1rem;
            max-height: 100px;
            resize: none;
            padding: 0;
            line-height: 1.4;
        }

        .action-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--msg-me);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
            transition: all 0.2s;
            cursor: pointer;
        }
        .action-btn.mic-mode { background: var(--msg-them); }

        .icon-btn {
            color: var(--accent);
            padding: 5px;
            cursor: pointer;
        }

        /* Voice Recorder UI */
        #recording-ui {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ff3b30;
            font-weight: 600;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Helpers */
        .hidden { display: none !important; }
        .copyable { cursor: pointer; }
        .contact-card {
            background: transparent;
            padding: 0.8rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 0.5px solid rgba(255,255,255,0.05);
        }
        .contact-card:active { background: rgba(255,255,255,0.05); }
        .avatar {
            width: 3.2rem;
            height: 3.2rem;
            background: #2c2c2e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
            color: white;
        }
        
        .modern-input {
            background: var(--bg-input);
            border: none;
            border-radius: 12px;
            padding: 12px;
            color: white;
            width: 100%;
            outline: none;
        }

        /* Language Overlay Bottom Sheet */
        .language-overlay {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            background: #1c1c1e;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s;
        }
        .language-overlay.show { transform: translateY(0); }
        .lang-opt {
            padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center;
        }
        .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .backdrop.show { opacity: 1; pointer-events: auto; }
        
        #scroll-down-btn {
            position: fixed; bottom: 80px; right: 20px;
            background: #262628; border: 1px solid #333; color: var(--accent);
            padding: 8px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 30; transition: opacity 0.3s;
        }

        .unread-badge {
            background: #007aff;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        #copy-menu {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            z-index: 100;
            flex-direction: column;
            gap: 0.5rem;
        }

        #preview-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
        }

        #contact-preview {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1.25rem;
            padding: 1.25rem;
            max-width: 90%;
            max-height: 70%;
            overflow-y: auto;
            z-index: 100;
        }

        .mini-chat {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mini-bubble {
            max-width: 80%;
            padding: 0.6rem 0.8rem;
            font-size: 0.8rem;
            line-height: 1.3;
            position: relative;
            white-space: pre-wrap;
            word-break: break-word;
            border-radius: 1rem;
        }

        .mini-bubble.me {
            align-self: flex-end;
            background-color: #007aff;
            color: white;
            border-radius: 1rem 1rem 0.15rem 1rem;
        }

        .mini-bubble.them {
            align-self: flex-start;
            background-color: #1c1c1e;
            color: white;
            border-radius: 1rem 1rem 1rem 0.15rem;
            border: 1px solid var(--border);
        }

        .file-preview {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .file-icon {
            font-size: 24px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slide-in {
            animation: slideIn 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
    </style>
</head>
<body>

    <!-- HTML structure remains the same as before -->

    <script>
        const API = "https://dh7.adamdh7.org";
        let user = JSON.parse(localStorage.getItem('dh7_session')) || null;
        let activePeer = null;
        let chatInterval = null;
        let homeInterval = null;
        let lastViewed = JSON.parse(localStorage.getItem('lastViewed')) || {};
        let currentLanguage = localStorage.getItem('language');
        if (!currentLanguage) {
            const browserLang = navigator.language.split('-')[0];
            if (['fr', 'en', 'es'].includes(browserLang)) {
                currentLanguage = browserLang;
            } else {
                currentLanguage = 'ht';
            }
            localStorage.setItem('language', currentLanguage);
        }
        let shownTfids = new Set();
        let replyingTo = null;
        const REPLY_START = '\u2063'; // Invisible separator for start of reply
        const REPLY_END = '\u2064'; // Invisible separator for end of reply
        let displayedMessageIds = new Set();
        const translations = {
            // translations remain the same
        };

        // CONFIG & STATE
        // Voice Recording State
        let mediaRecorder = null;
        let audioChunks = [];
        let recordStartTime = 0;
        let recordTimerInterval = null;

        // --- INIT & AUTH ---
        if(user) {
            startApp();
        } else {
            navTo('scr-auth');
        }

        function startApp() {
            if (!user) return;
            document.getElementById('m-name').innerText = `${user.prenom} ${user.nom}`;
            document.getElementById('m-dh7').innerText = user.dh7;
            document.getElementById('m-tfid').innerText = user.tfid;
            document.getElementById('m-init').innerText = user.nom[0];
            changeLanguage(currentLanguage);
            handleRouting();
            setupNotifications();
            // Initialiser les écouteurs pour le bouton d'action (Mic/Send)
            initActionBtn();
        }

        // Other functions like getUserByTfid, getUserByIdentifier, openChatByIdentifier, login, register, toggleAuth, logout remain the same

        // --- NAVIGATION ---
        // navTo, onpopstate, handleRouting remain the same

        // --- CONTACTS & LIST ---
        // loadContacts, sortContacts, getUnreadCount, updateContacts, updateAppBadge, doSearch remain the same

        async function openChat(peer) {
            if (!peer) return;
            activePeer = peer;
            document.getElementById('chat-peer-name').innerText = `${peer.prenom} ${peer.nom}`;
            document.getElementById('chat-peer-tfid').innerText = peer.tfid;
            navTo('scr-chat');
            resetChatView();
            syncChatSilently();
            try {
                const msgsRes = await fetch(`${API}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user1_tfid: user.tfid, user2_tfid: activePeer.tfid })
                });
                if (!msgsRes.ok) throw new Error('Failed to fetch messages');
                const messages = await msgsRes.json();
                const unread = messages.filter(m => m.from === activePeer.tfid && !m.read && m.text !== 'ok').length;
                if (unread > 0) {
                    await fetch(`${API}/mark-read`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sender_tfid: activePeer.tfid, receiver_tfid: user.tfid }) 
                    });
                    let totalUnread = parseInt(localStorage.getItem('totalUnread') || '0') - unread;
                    localStorage.setItem('totalUnread', totalUnread);
                    updateAppBadge(totalUnread);
                }
                lastViewed[peer.tfid] = Date.now();
                localStorage.setItem('lastViewed', JSON.stringify(lastViewed));
            } catch (e) {
                console.error(e);
            }
            chatInterval = setInterval(syncChatSilently, 3000);
            setupScrollListener();
        }

        function resetChatView() {
            displayedMessageIds.clear();
            document.getElementById('chat-messages').innerHTML = '';
        }

        // --- CHAT SYNC ---
        async function syncChatSilently() {
            if (!activePeer) return;

            try {
                const res = await fetch(`${API}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user1_tfid: user.tfid, user2_tfid: activePeer.tfid })
                });
                
                const messages = await res.json();
                const container = document.getElementById('chat-messages');
                
                // Filtre les nouveaux messages (pas 'ok' et pas déjà affichés)
                const newMessages = messages.filter(m => {
                    const msgId = m.time + m.from;
                    return m.text !== 'ok' && !displayedMessageIds.has(msgId);
                });

                if (newMessages.length > 0) {
                    const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 150;

                    newMessages.forEach(m => {
                        const msgId = m.time + m.from;
                        displayedMessageIds.add(msgId);
                        appendMessageToDOM(m);
                    });

                    if (isAtBottom) {
                        scrollToBottom();
                    }
                }
                
                // Mise à jour des status
                updateCheckmarks(messages);

            } catch (e) {
                // Silent
            }
        }

        function appendMessageToDOM(m) {
            const container = document.getElementById('chat-messages');
            const isMe = m.from === user.tfid;
            
            const div = document.createElement('div');
            div.className = `bubble ${isMe ? 'me' : 'them'} animate-slide-in`;
            div.id = `msg-${m.time.replace(/[^a-zA-Z0-9]/g, '-')}`;
            
            let text = m.text;
            if (text.startsWith(REPLY_START)) {
                let pos = REPLY_START.length;
                const idEnd = text.indexOf(REPLY_END, pos);
                const id = text.substring(pos, idEnd);
                pos = idEnd + REPLY_END.length;
                const senderEnd = text.indexOf(REPLY_END, pos);
                const sender = text.substring(pos, senderEnd);
                pos = senderEnd + REPLY_END.length;
                const quoted = text.substring(pos, text.indexOf(REPLY_END, pos));
                pos = text.indexOf(REPLY_END, pos) + REPLY_END.length;
                const main = text.substring(pos).trim();
                const replyDiv = document.createElement('div');
                replyDiv.className = 'reply-bar';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'reply-name';
                nameSpan.innerText = sender;
                replyDiv.appendChild(nameSpan);
                const textSpan = document.createElement('span');
                textSpan.className = 'reply-text';
                const lines = quoted.split('\n');
                const displayText = lines[0] + (lines.length > 1 ? '•••' : '');
                textSpan.innerText = displayText;
                replyDiv.appendChild(textSpan);
                replyDiv.classList.add(sender === translations[currentLanguage].you ? 'reply-me' : 'reply-them');
                replyDiv.onclick = () => {
                    const original = document.getElementById('msg-' + id);
                    if (original) {
                        original.scrollIntoView({behavior: 'smooth'});
                    }
                };
                div.appendChild(replyDiv);
                const mainSpan = document.createElement('span');
                mainSpan.className = 'main-message';
                mainSpan.innerHTML = renderText(main);
                div.appendChild(mainSpan);
            } else {
                div.innerHTML = renderText(text);
            }
            
            if (isMe) {
                const status = document.createElement('span');
                status.className = 'status';
                status.innerText = '✓'; // Initial, updated later
                div.appendChild(status);
            }

            addMessageListeners(div, text);
            container.appendChild(div);
        }

        function updateCheckmarks(messages) {
            messages.forEach((m, index) => {
                if (m.from !== user.tfid || m.text === 'ok') return;
                const bubble = document.getElementById(`msg-${m.time.replace(/[^a-zA-Z0-9]/g, '-')}`);
                if (!bubble) return;
                let read = m.read;
                for (let j = index + 1; j < messages.length; j++) {
                    if (messages[j].from !== user.tfid && messages[j].text !== 'ok') {
                        read = true;
                        break;
                    }
                }
                const status = bubble.querySelector('.status');
                if (status) {
                    const newText = read ? '✓✓' : '✓';
                    if (status.innerText !== newText) {
                        status.innerText = newText;
                    }
                    if (read) {
                        status.classList.add('read');
                    } else {
                        status.classList.remove('read');
                    }
                }
            });
        }

        // Other functions like setupScrollListener, scrollToBottom, getMainMessage, addMessageListeners, sendMessage, replyToMessage, cancelReply, autoResize, setupNotifications, urlB64ToUint8Array, renderText, getFilenameFromMime, openFullscreen, closeFullscreen, openFileInNewTab, handleInput, initActionBtn, updateActionButton, startRecording, endRecordingOrSend, cancelRecording, startTimer, stopTimer, handleFileSelect, sendMedia, postData, showLang, closeOverlays, changeLanguage, showCopyMenu, hideCopyMenu, handleOutsideTouch, copyToClipboard, addLongPressListeners, showContactPreview, hideContactPreview remain the same

        document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
        document.addEventListener('touchmove', function (e) { if (e.scale !== 1) { e.preventDefault(); } }, { passive: false });
        document.addEventListener('contextmenu', (e) => e.preventDefault());

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('Service Worker registered');
                }).catch(function(err) {
                    console.log('Service Worker registration failed: ', err);
                });
            });
        }

        const msgInput = document.getElementById('msg-input');
        if (msgInput) {
            msgInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const start = msgInput.selectionStart;
                    msgInput.value = msgInput.value.substring(0, start) + '\n' + msgInput.value.substring(start);
                    msgInput.selectionStart = msgInput.selectionEnd = start + 1;
                    autoResize(msgInput);
                }
            };
        }

        changeLanguage(currentLanguage);
    </script>
</body>
</html>
