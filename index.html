<!DOCTYPE html>
<html lang="ht">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>D'H7 | Digital Hub 7</title>
    <meta name="description" content="D'H7 (Digital Hub 7) se yon platfòm kominikasyon sekirize ki pèmèt ou jere idantite dijital ou ak yon TFID/D'H7 inik. Konekte kounye a pou w jwenn aksè nan yon rezo pwoteze, miltiling (Kreyòl, Fransè, Angle, Espanyòl), epi fasil pou itilize.">

    <link rel="icon" type="image/png" href="https://www.adamdh7.org/asset/IMG_7023.png">
    <link rel="shortcut icon" href="https://www.adamdh7.org/asset/IMG_7023.png">
    <link rel="canonical" href="https://www.adamdh7.org/" />
    <link rel="apple-touch-icon" href="https://www.adamdh7.org/asset/IMG_7023.png" />

    <meta property="og:title" content="D'H7 - Digital Hub 7">
    <meta property="og:description" content="Konekte sou D'H7 pou yon eksperyans dijital sekirize.">
    <meta property="og:image" content="https://www.adamdh7.org/asset/IMG_7023.png">
    <meta property="og:url" content="https://www.adamdh7.org">
    <meta property="og:type" content="website">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "D'H7",
      "alternateName": "Digital Hub 7",
      "url": "https://www.adamdh7.org",
      "logo": "https://www.adamdh7.org/asset/IMG_7023.png"
    }
    </script>

    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-pure: #000000;
            --bg-card: #0a0a0a;
            --bg-input: #121212;
            --accent: #ffffff;
            --border: #1a1a1a;
            --text-dim: #666666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-pure);
            color: white;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
        }

        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-pure);
            z-index: 10;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s;
        }

        .screen.hidden-left { transform: translateX(-100%); opacity: 0; pointer-events: none; }
        .screen.hidden-right { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .screen.active { transform: translateX(0); opacity: 1; pointer-events: auto; }

        .ios-header {
            padding: env(safe-area-inset-top) 1.5rem 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 10;
        }

        /* Scroll doux et naturel comme WhatsApp */
        .chat-container, #contact-list, #search-results {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            scroll-behavior: smooth;
            margin-top: calc(env(safe-area-inset-top) + 5rem);
            overscroll-behavior-y: contain;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y pinch-zoom;
        }

        .chat-container::-webkit-scrollbar, #contact-list::-webkit-scrollbar, #search-results::-webkit-scrollbar { 
            display: none; 
            width: 0;
        }

        .bubble {
            max-width: 75%;
            padding: 0.85rem 1.1rem;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .bubble.me {
            align-self: flex-end;
            background-color: #007aff;
            color: white;
            border-radius: 1.25rem 1.25rem 0.2rem 1.25rem;
            font-weight: 500;
        }

        .bubble.them {
            align-self: flex-start;
            background-color: #1c1c1e;
            color: white;
            border-radius: 1.25rem 1.25rem 1.25rem 0.2rem;
            border: 1px solid var(--border);
        }

        .reply-bar {
            background: #282828;
            border-radius: 0.5rem;
            padding: 0.5rem 0.6rem 0.5rem 1.2rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: #a0a0a0;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .bubble.me .reply-bar {
            background: #0060df;
        }

        .reply-bar::before {
            content: '';
            position: absolute;
            left: 0.6rem;
            top: 0.5rem;
            bottom: 0.5rem;
            width: 4px;
            background: #a0a0a0;
            border-radius: 2px;
        }

        .reply-bar.reply-me::before {
            background: #ffffff;
        }

        .reply-bar.reply-them::before {
            background: #007aff;
        }

        .reply-name {
            font-size: 0.8rem;
            font-weight: bold;
            color: #007aff;
            display: block;
        }

        .bubble.me .reply-name {
            color: #fff;
        }

        .reply-text {
            font-size: 0.8rem;
            color: #a0a0a0;
            display: block;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .bubble.me .reply-text {
            color: #d0d0d0;
        }

        .main-message {
            display: block;
            margin-top: 0.2rem;
        }

        .status {
            position: absolute;
            bottom: -12px;
            right: 8px;
            font-size: 0.65rem;
            color: #a0a0a0;
            font-weight: bold;
        }

        .status.read {
            color: #007aff;
        }

        .input-area {
            padding: 1rem 1.5rem calc(1rem + env(safe-area-inset-bottom)) 1.5rem;
            background: var(--bg-pure);
            border-top: 1px solid var(--border);
        }

        .contact-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1.25rem;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.1s;
        }

        .contact-card:active { transform: scale(0.97); }

        .avatar {
            width: 3.5rem;
            height: 3.5rem;
            background: linear-gradient(135deg, #111, #222);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.2rem;
            border: 1px solid var(--border);
        }

        .unread-badge {
            background: #007aff;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .logo {
            cursor: pointer;
        }

        #msg-input {
            resize: none;
            overflow: hidden;
            min-height: 40px;
            max-height: 120px;
            user-select: text;
        }

        .hidden { display: none !important; }

        #scroll-down {
            position: fixed;
            bottom: calc(6rem + env(safe-area-inset-bottom));
            right: 1.5rem;
            background: rgba(0, 122, 255, 0.8);
            border-radius: 50%;
            padding: 0.75rem;
            z-index: 20;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: opacity 0.3s;
        }

        #scroll-down.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #voice-timer {
            position: absolute;
            bottom: calc(100% + 0.5rem);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 10;
        }

        .media-preview {
            max-width: 100%;
            border-radius: 1rem;
            cursor: pointer;
        }

        #fullscreen-overlay {
            position: fixed;
            inset: 0;
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        #fullscreen-media {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
        }

        #fullscreen-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <section id="scr-auth" class="screen active items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-7xl font-black tracking-tighter mb-2 italic logo" data-key="logo" onclick="showLanguageSelector()">D'H7</h1>
            <p class="text-zinc-600 text-xs uppercase tracking-[0.6em] mb-16" data-key="subtitle">Digital HUB 7</p>
            
            <div id="login-form" class="space-y-4">
                <input type="text" id="login-id" data-key="placeholder-tfid" placeholder="TFID oswa DH7" class="bg-zinc-900 border border-zinc-800 rounded-2xl py-5 px-6 w-full text-white">
                <input type="password" id="login-pass" data-key="placeholder-password" placeholder="Modpas" class="bg-zinc-900 border border-zinc-800 rounded-2xl py-5 px-6 w-full text-white">
                <button onclick="login()" class="w-full bg-white text-black font-black py-5 rounded-2xl mt-4 text-lg" data-key="connect">LOG IN</button>
                <button onclick="toggleAuth()" class="w-full text-zinc-500 text-sm mt-4" data-key="register">KREYE YON KONT</button>
            </div>

            <div id="reg-form" class="hidden space-y-4">
                <div class="flex gap-2">
                    <input type="text" id="reg-nom" data-key="placeholder-lastname" placeholder="Nom" class="bg-zinc-900 border border-zinc-800 rounded-2xl py-5 px-6 w-full text-white">
                    <input type="text" id="reg-prenom" data-key="placeholder-firstname" placeholder="Prenom" class="bg-zinc-900 border border-zinc-800 rounded-2xl py-5 px-6 w-full text-white">
                </div>
                <input type="text" id="reg-dh7" data-key="placeholder-dh7" placeholder="DH7 ID (ex: adamdh7@dh7.tf)" class="bg-zinc-900 border border-zinc-800 rounded-2xl py-5 px-6 w-full text-white">
                <input type="number" id="reg-age" data-key="placeholder-age" placeholder="Laj" class="bg-zinc-900 border border-zinc-800 rounded-2xl py-5 px-6 w-full text-white">
                <input type="password" id="reg-pass" data-key="placeholder-password" placeholder="Modpas" class="bg-zinc-900 border border-zinc-800 rounded-2xl py-5 px-6 w-full text-white">
                <button onclick="register()" class="w-full bg-white text-black font-black py-5 rounded-2xl mt-4 text-lg" data-key="create-account">JOIN D'H7</button>
                <button onclick="toggleAuth()" class="w-full text-zinc-500 text-sm mt-4" data-key="back-to-login">RETOUNEN</button>
            </div>
        </div>
    </section>

    <section id="scr-home" class="screen hidden-right">
        <header class="ios-header flex justify-between items-end">
            <div>
                <h2 class="text-4xl font-black tracking-tighter logo" data-key="logo" onclick="showLanguageSelector()">Mesaj</h2>
            </div>
            <div class="flex gap-6 pb-1">
                <button onclick="navTo('scr-search')">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </button>
                <button onclick="navTo('scr-menu')">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM18 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                </button>
            </div>
        </header>
        
        <div id="contact-list"></div>
    </section>

    <section id="scr-chat" class="screen hidden-right">
        <header class="ios-header flex items-center gap-4">
            <button onclick="navTo('scr-home')" class="p-1">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div class="flex-1 min-w-0">
                <h3 id="chat-peer-name" class="font-bold text-lg leading-none truncate">---</h3>
                <p id="chat-peer-tfid" class="text-[10px] text-zinc-500 font-mono mt-1 tracking-widest uppercase truncate copyable" onclick="copyToClipboard(this.innerText)">---</p>
            </div>
        </header>

        <div id="chat-messages" class="chat-container"></div>

        <div id="reply-preview" class="hidden mx-4">
            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-3 flex justify-between items-center">
                <span id="reply-text" class="text-sm text-zinc-400"></span>
                <span id="cancel-reply" class="text-blue-500 cursor-pointer text-xl">×</span>
            </div>
        </div>

        <div class="input-area">
            <div id="voice-timer" class="hidden">
                <span id="voice-timer-time">00:00</span>
                <i class="fas fa-times cursor-pointer text-white ml-2" onclick="stopRecord(true)"></i>
            </div>
            <div class="flex items-end bg-zinc-900 rounded-full p-2 border border-zinc-800 gap-2">
                <button id="attach-btn" class="p-2 text-blue-500">
                    <i class="fas fa-paperclip text-xl"></i>
                </button>
                <textarea id="msg-input" data-key="message-placeholder" placeholder="Ekri yon mesaj..." class="flex-1 bg-transparent border-none p-2 outline-none text-white" rows="1" oninput="autoResize(this); updateActionButton();"></textarea>
                <button id="action-btn" class="p-2 text-blue-500">
                    <i class="fas fa-microphone text-xl"></i>
                </button>
            </div>
            <input type="file" id="file-input" hidden>
        </div>

        <div id="scroll-down" class="hidden" onclick="scrollToBottom()">
            <svg class="w-6 h-6" fill="none" stroke="white" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
            </svg>
        </div>
    </section>

    <section id="scr-search" class="screen hidden-right">
        <header class="ios-header flex items-center gap-4">
            <input type="text" id="search-q" oninput="doSearch()" data-key="search-placeholder" placeholder="Chèche nan D'H7..." class="flex-1 bg-zinc-900 border border-zinc-800 rounded-2xl py-3 px-5 text-white">
            <button onclick="navTo('scr-home')" class="text-sm font-bold text-zinc-400" data-key="close">ANILE</button>
        </header>
        <div id="search-results"></div>
    </section>

    <section id="scr-menu" class="screen hidden-right">
        <div class="flex-1 flex flex-col items-center justify-center p-10 text-center">
            <div class="w-24 h-24 bg-zinc-900 rounded-full mb-4 flex items-center justify-center text-4xl font-black border border-zinc-800" id="m-init">?</div>
            <h2 id="m-name" class="text-4xl font-black mb-1">---</h2>
            <p id="m-dh7" class="text-zinc-500 font-mono mb-4 copyable" onclick="copyToClipboard(this.innerText)">---</p>
            
            <div class="w-full max-w-xs space-y-4">
                <div class="p-6 bg-zinc-900 rounded-3xl border border-zinc-800 text-left">
                    <p class="text-[10px] text-zinc-600 font-black uppercase tracking-widest mb-2" data-key="personal-tfid">TFID Sekirize</p>
                    <p id="m-tfid" class="text-xl font-mono text-white copyable" onclick="copyToClipboard(this.innerText)">---</p>
                </div>
                <button onclick="showLanguageSelector()" class="w-full py-5 text-white font-black tracking-widest bg-zinc-900/50 rounded-2xl border border-zinc-800" data-key="language">LANGUE</button>
                <button onclick="logout()" class="w-full py-5 text-red-500 font-black tracking-widest bg-red-500/5 rounded-2xl border border-red-500/10" data-key="logout">DEKONEKTE</button>
                <button onclick="navTo('scr-home')" class="w-full py-5 text-zinc-500 font-bold" data-key="close">RETOUNEN</button>
            </div>
        </div>
    </section>

    <div id="language-overlay" class="fixed inset-0 bg-black/50 flex items-end z-50 hidden">
        <div class="w-full bg-zinc-900 rounded-t-3xl p-6">
            <div class="w-12 h-1 bg-zinc-600 rounded-full mx-auto mb-6"></div>
            <div class="space-y-2">
                <div class="py-4 text-center text-lg" onclick="changeLanguage('es')">Español</div>
                <div class="py-4 text-center text-lg" onclick="changeLanguage('en')">English</div>
                <div class="py-4 text-center text-lg" onclick="changeLanguage('fr')">Français</div>
                <div class="py-4 text-center text-lg font-bold" onclick="changeLanguage('ht')">Kreyòl Ayisyen</div>
            </div>
        </div>
    </div>

    <div id="preview-overlay" class="hidden" onclick="hideContactPreview()"></div>
    <div id="contact-preview" class="hidden"></div>
    <div id="copy-menu" class="hidden flex flex-col gap-2">
        <button id="copy-btn" data-key="copy"></button>
        <button id="reply-btn" data-key="reply"></button>
    </div>

    <script>
        const API = "https://dh7.adamdh7.org";
        const UPLOAD_URL = "https://url.tergenedhaiti.workers.dev/";
        const FILE_START = '\u2061';
        const FILE_END = '\u2062';
        const REPLY_START = '\u2063';
        const REPLY_END = '\u2064';
        let user = JSON.parse(localStorage.getItem('dh7_session')) || null;
        let activePeer = null;
        let chatInterval = null;
        let homeInterval = null;
        let lastViewed = JSON.parse(localStorage.getItem('lastViewed')) || {};
        let currentLanguage = localStorage.getItem('language') || 'ht';
        let shownTfids = new Set();
        let replyingTo = null;
        let recorder = null;
        let audioChunks = [];
        let recordingTimer = null;
        let recordingSeconds = 0;

        const translations = { /* même objet que précédemment */ 
            ht: { logo: "D'H7", subtitle: "Digital HUB 7", "placeholder-tfid": "TFID oswa DH7", "placeholder-password": "Modpas", connect: "Konekte", register: "KREYE YON KONT", "placeholder-lastname": "Nom", "placeholder-firstname": "Prenom", "placeholder-dh7": "DH7 ID (ex: adamdh7@dh7.tf)", "placeholder-age": "Laj", "create-account": "JOIN D'H7", "back-to-login": "RETOUNEN", "search-placeholder": "Chèche nan D'H7...", "personal-tfid": "TFID Sekirize", language: "LANGUE", logout: "DEKONEKTE", close: "ANILE", "message-placeholder": "Ekri yon mesaj...", no_contacts: "Pa gen kontak pako. Chèche moun pou kòmanse pale.", copy: "Kopi", reply: "Reponn", copied: "Kopi", you: "Ou" },
            fr: { logo: "D'H7", subtitle: "Digital HUB 7", "placeholder-tfid": "TFID ou DH7", "placeholder-password": "Mot de passe", connect: "Se connecter", register: "CRÉER UN COMPTE", "placeholder-lastname": "Nom", "placeholder-firstname": "Prénom", "placeholder-dh7": "DH7 ID (ex: adamsdhaiti@dh7.tf)", "placeholder-age": "Âge", "create-account": "REJOINDRE D'H7", "back-to-login": "RETOUR", "search-placeholder": "Rechercher dans D'H7...", "personal-tfid": "TFID Sécurisé", language: "LANGUE", logout: "SE DÉCONNECTER", close: "ANNULER", "message-placeholder": "Écrire un message...", no_contacts: "Pas de contacts encore. Recherchez des personnes pour commencer à parler.", copy: "Copier", reply: "Répondre", copied: "Copié", you: "Vous" },
            en: { logo: "D'H7", subtitle: "Digital HUB 7", "placeholder-tfid": "TFID or DH7", "placeholder-password": "Password", connect: "Login", register: "CREATE AN ACCOUNT", "placeholder-lastname": "Last Name", "placeholder-firstname": "First Name", "placeholder-dh7": "DH7 ID (ex: adamsdhaiti@dh7.tf)", "placeholder-age": "Age", "create-account": "JOIN D'H7", "back-to-login": "BACK", "search-placeholder": "Search in D'H7...", "personal-tfid": "Secure TFID", language: "LANGUAGE", logout: "LOGOUT", close: "CANCEL", "message-placeholder": "Type a message...", no_contacts: "No contacts yet. Search for people to start talking.", copy: "Copy", reply: "Reply", copied: "Copied", you: "You" },
            es: { logo: "D'H7", subtitle: "Digital HUB 7", "placeholder-tfid": "TFID o DH7", "placeholder-password": "Contraseña", connect: "Conectar", register: "CREAR UNA CUENTA", "placeholder-lastname": "Apellido", "placeholder-firstname": "Nombre", "placeholder-dh7": "DH7 ID (ej: adamsdhaiti@dh7.tf)", "placeholder-age": "Edad", "create-account": "UNIRSE A D'H7", "back-to-login": "REGRESAR", "search-placeholder": "Buscar en D'H7...", "personal-tfid": "TFID Seguro", language: "IDIOMA", logout: "CERRAR SESIÓN", close: "CANCELAR", "message-placeholder": "Escribe un mensaje...", no_contacts: "No hay contactos aún. Busca personas para comenzar a hablar.", copy: "Copiar", reply: "Responder", copied: "Copiado", you: "Tú" }
        };

        /* Toutes les fonctions identiques à la version précédente (navTo, login, register, loadContacts, openChat, fetchMessages, renderText, send, uploadFile, showFullscreen, etc.) */

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function updateActionButton() {
            const input = document.getElementById('msg-input');
            const btn = document.getElementById('action-btn');
            if (input.value.trim()) {
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>';
                btn.onclick = sendMessage;
            } else {
                btn.innerHTML = '<i class="fas fa-microphone text-xl"></i>';
                btn.onclick = null;
            }
        }

        async function startRecord() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(stream);
                audioChunks = [];
                recorder.ondataavailable = e => audioChunks.push(e.data);
                recorder.start();
                recordingSeconds = 0;
                document.getElementById('voice-timer-time').textContent = '00:00';
                document.getElementById('voice-timer').classList.remove('hidden');
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    document.getElementById('voice-timer-time').textContent = formatTime(recordingSeconds);
                }, 1000);
            } catch (e) {
                alert("Mikwofòn pa disponib");
            }
        }

        function stopRecord(cancel = false) {
            if (!recorder) return;
            recorder.stop();
            recorder.stream.getTracks().forEach(t => t.stop());
            clearInterval(recordingTimer);
            document.getElementById('voice-timer').classList.add('hidden');
            if (!cancel && audioChunks.length > 0) {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const filename = `${Date.now()}-voice.webm`;
                uploadFile(blob, filename, 'audio/webm');
            }
            recorder = null;
            audioChunks = [];
        }

        function formatTime(s) {
            const m = String(Math.floor(s / 60)).padStart(2, '0');
            const sec = String(s % 60).padStart(2, '0');
            return `${m}:${sec}`;
        }

        async function uploadFile(file, filename = null, type = null) {
            if (!file) return;
            filename = filename || `${Date.now()}-${file.name.replace(/ /g, '_')}`;
            type = type || file.type || 'application/octet-stream';
            try {
                const res = await fetch(`${UPLOAD_URL}${encodeURIComponent(filename)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': type },
                    body: file
                });
                if (!res.ok) throw new Error();
                const link = await res.text();
                const wrapped = FILE_START + link + FILE_END;
                sendMessage(wrapped);
            } catch (e) {
                alert("Upload echwe");
            }
        }

        function showFullscreen(src, type = 'image') {
            const overlay = document.createElement('div');
            overlay.id = 'fullscreen-overlay';
            const media = type === 'image' ? document.createElement('img') : document.createElement('video');
            media.id = 'fullscreen-media';
            media.src = src;
            if (type === 'video') {
                media.controls = true;
                media.autoplay = true;
            }
            const close = document.createElement('span');
            close.id = 'fullscreen-close';
            close.innerHTML = '×';
            close.onclick = () => overlay.remove();
            overlay.appendChild(media);
            overlay.appendChild(close);
            overlay.onclick = e => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);
        }

        function renderText(parent, text) {
            const trimmed = text.trim();
            if (text.startsWith(FILE_START)) {
                const link = text.slice(FILE_START.length, -FILE_END.length);
                const ext = link.split('.').pop().toLowerCase();
                if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                    parent.innerHTML = `<img src="${link}" class="media-preview" onclick="showFullscreen('${link}', 'image')">`;
                } else if (['mp4','webm','mov','avi','mkv'].includes(ext)) {
                    parent.innerHTML = `<video src="${link}" class="media-preview" controls onclick="event.stopPropagation(); showFullscreen('${link}', 'video')"></video>`;
                } else if (['mp3','wav','ogg','webm'].includes(ext)) {
                    parent.innerHTML = `<audio src="${link}" controls class="w-full mt-2"></audio>`;
                } else {
                    const name = link.split('-').slice(1).join('-').split('.')[0];
                    parent.innerHTML = `<a href="${link}" target="_blank" class="text-blue-400 underline">${name || 'Fichye'}</a>`;
                }
            } else if (/^https?:\/\/url\.adamdh7\.org\//.test(trimmed)) {
                // Même logique que ci-dessus pour les liens directs url.adamdh7.org
                renderText(parent, FILE_START + trimmed + FILE_END);
            } else if (trimmed.match(/^TF-\d{6}$/) || trimmed.endsWith('@dh7.tf')) {
                parent.innerHTML = `<a onclick="openChatByIdentifier('${trimmed}')">${text}</a>`;
            } else if (/^https?:\/\//.test(trimmed)) {
                parent.innerHTML = `<a href="${trimmed}" target="_blank" class="text-blue-400 underline">${trimmed}</a>`;
            } else {
                parent.textContent = text;
            }
        }

        document.getElementById('attach-btn').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = e => e.target.files[0] && uploadFile(e.target.files[0]);

        // Long press sur le bouton micro pour enregistrer
        let micTimer;
        document.getElementById('action-btn').addEventListener('touchstart', e => {
            if (!document.getElementById('msg-input').value.trim()) {
                e.preventDefault();
                micTimer = setTimeout(startRecord, 300);
            }
        });
        document.getElementById('action-btn').addEventListener('touchend', e => {
            if (!document.getElementById('msg-input').value.trim()) {
                clearTimeout(micTimer);
                if (recorder) stopRecord();
            }
        });

        // Focus input → scroll en bas
        document.getElementById('msg-input')?.addEventListener('focus', () => setTimeout(scrollToBottom, 300));

        changeLanguage(currentLanguage);
        if (user) startApp();
        else navTo('scr-auth');
    </script>
</body>
</html>
