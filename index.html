<!DOCTYPE html>
<html lang="ht">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>D'H7</title>
    <link rel="icon" href="https://www.adamdh7.org/asset/IMG_7023.png">
    <link rel="manifest" href="manifest.json" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="apple-touch-icon" href="asset/IMG_7023.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg-pure: #000000; --bg-card: #0a0a0a; --bg-input: #121212; --accent: #ffffff; --border: #1a1a1a; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-pure); color: white; font-family: 'Inter', sans-serif; height: 100vh; width: 100vw; overflow: hidden; user-select: none; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background-color: var(--bg-pure); z-index: 10; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s; }
        .screen.hidden-left { transform: translateX(-100%); opacity: 0; pointer-events: none; }
        .screen.hidden-right { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .screen.active { transform: translateX(0); opacity: 1; pointer-events: auto; }
        .ios-header { padding: env(safe-area-inset-top) 1.5rem 1rem 1.5rem; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); position: fixed; top: 0; left: 0; width: 100%; z-index: 10; }
        .chat-container { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem; margin-top: calc(env(safe-area-inset-top) + 5rem); -webkit-overflow-scrolling: touch; }
        .bubble { max-width: 75%; padding: 0.85rem 1.1rem; font-size: 0.95rem; border-radius: 1.25rem; word-break: break-word; }
        .bubble.me { align-self: flex-end; background: #007aff; border-bottom-right-radius: 0.2rem; }
        .bubble.them { align-self: flex-start; background: #1c1c1e; border: 1px solid var(--border); border-bottom-left-radius: 0.2rem; }
        .input-area { padding: 1rem 1.5rem calc(1rem + env(safe-area-inset-bottom)) 1.5rem; background: var(--bg-pure); border-top: 1px solid var(--border); }
        .modern-input { background: var(--bg-input); border: 1px solid var(--border); border-radius: 1.5rem; padding: 0.75rem 1.25rem; width: 100%; color: white; outline: none; }
        .contact-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 1.25rem; padding: 1.25rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; }
        .avatar { width: 3rem; height: 3rem; background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; }
        .unread-badge { background: #007aff; color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <section id="scr-auth" class="screen active items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-7xl font-black italic mb-2">D'H7</h1>
            <div id="login-form" class="space-y-4 mt-10">
                <input type="text" id="login-id" placeholder="TFID oswa DH7" class="modern-input py-5">
                <input type="password" id="login-pass" placeholder="Modpas" class="modern-input py-5">
                <button onclick="login()" class="w-full bg-white text-black font-black py-5 rounded-2xl">LOG IN</button>
                <button onclick="toggleAuth()" class="text-zinc-500 text-sm">KREYE YON KONT</button>
            </div>
            <div id="reg-form" class="hidden space-y-4 mt-10">
                <input type="text" id="reg-nom" placeholder="Nom" class="modern-input">
                <input type="text" id="reg-prenom" placeholder="Prenom" class="modern-input">
                <input type="text" id="reg-dh7" placeholder="DH7 ID" class="modern-input">
                <input type="number" id="reg-age" placeholder="Laj" class="modern-input">
                <input type="password" id="reg-pass" placeholder="Modpas" class="modern-input">
                <button onclick="register()" class="w-full bg-white text-black font-black py-5 rounded-2xl">JOIN D'H7</button>
                <button onclick="toggleAuth()" class="text-zinc-500 text-sm">RETOUNEN</button>
            </div>
        </div>
    </section>

    <section id="scr-home" class="screen hidden-right">
        <header class="ios-header flex justify-between items-end">
            <h2 class="text-4xl font-black">Mesaj</h2>
            <div class="flex gap-6 pb-1">
                <button onclick="navTo('scr-search')"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></button>
                <button onclick="navTo('scr-menu')"><svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM18 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg></button>
            </div>
        </header>
        <div id="contact-list" class="flex-1 overflow-y-auto p-6 mt-24"></div>
    </section>

    <section id="scr-chat" class="screen hidden-right">
        <header class="ios-header flex items-center gap-4">
            <button onclick="navTo('scr-home')"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M15 19l-7-7 7-7"/></svg></button>
            <div class="flex-1 truncate">
                <h3 id="chat-peer-name" class="font-bold text-lg">---</h3>
                <p id="chat-peer-tfid" class="text-[10px] text-zinc-500 font-mono">---</p>
            </div>
        </header>
        <div id="chat-messages" class="chat-container"></div>
        <div class="input-area">
            <div class="flex gap-2 bg-zinc-900 rounded-full p-2">
                <input id="msg-input" placeholder="Mesaj..." class="flex-1 bg-transparent p-2 outline-none text-white">
                <button onclick="sendMessage()" class="p-2 text-blue-600"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"/></svg></button>
            </div>
        </div>
    </section>

    <section id="scr-search" class="screen hidden-right">
        <header class="ios-header flex items-center gap-4">
            <input type="text" id="search-q" oninput="doSearch()" placeholder="Chèche..." class="flex-1 modern-input">
            <button onclick="navTo('scr-home')" class="text-zinc-400">ANILE</button>
        </header>
        <div id="search-results" class="flex-1 p-6 mt-24"></div>
    </section>

    <section id="scr-menu" class="screen hidden-right">
        <div class="flex-1 flex flex-col items-center justify-center p-10 text-center">
            <div class="w-24 h-24 bg-zinc-900 rounded-full mb-4 flex items-center justify-center text-4xl font-black" id="m-init">?</div>
            <h2 id="m-name" class="text-3xl font-black">---</h2>
            <p id="m-tfid" class="text-zinc-500 font-mono mb-8">---</p>
            <button onclick="logout()" class="w-full py-5 text-red-500 font-bold bg-red-500/5 rounded-2xl border border-red-500/10">DEKONEKTE</button>
            <button onclick="navTo('scr-home')" class="mt-4 text-zinc-500">RETOUNEN</button>
        </div>
    </section>

    <script>
        const API = "https://dh7.adamdh7.org";
        let user = JSON.parse(localStorage.getItem('dh7_session')) || null;
        let activePeer = null;
        let chatInterval = null;

        function navTo(screenId) {
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active', 'hidden-left', 'hidden-right');
                s.id === screenId ? s.classList.add('active') : s.classList.add('hidden-right');
            });
            if (screenId === 'scr-home') loadContacts();
            if (screenId !== 'scr-chat') clearInterval(chatInterval);
        }

        async function login() {
            const id = document.getElementById('login-id').value;
            const pass = document.getElementById('login-pass').value;
            try {
                const res = await fetch(`${API}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier: id, password: pass })
                });
                const data = await res.json();
                if (data.success) {
                    user = data.user;
                    localStorage.setItem('dh7_session', JSON.stringify(user));
                    startApp();
                } else alert(data.error);
            } catch (e) { alert("Sèvè a pa reponn"); }
        }

        async function register() {
            const data = {
                nom: document.getElementById('reg-nom').value,
                prenom: document.getElementById('reg-prenom').value,
                dh7: document.getElementById('reg-dh7').value,
                age: document.getElementById('reg-age').value,
                password: document.getElementById('reg-pass').value
            };
            try {
                const res = await fetch(`${API}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) { alert("Kont kreye! TFID: " + result.tfid); toggleAuth(); }
                else alert(result.error);
            } catch (e) { alert("Erè koneksyon"); }
        }

        async function loadContacts() {
            const container = document.getElementById('contact-list');
            try {
                const res = await fetch(`${API}/users`);
                const users = await res.json();
                container.innerHTML = '';
                users.filter(u => u.tfid !== user.tfid).forEach(u => {
                    const card = document.createElement('div');
                    card.className = "contact-card";
                    card.innerHTML = `<div class="avatar">${u.nom[0]}</div><div class="flex-1"><p class="font-bold">${u.prenom} ${u.nom}</p><p class="text-xs text-zinc-500">${u.tfid}</p></div>`;
                    card.onclick = () => openChat(u);
                    container.appendChild(card);
                });
            } catch (e) { console.error(e); }
        }

        async function doSearch() {
            const q = document.getElementById('search-q').value.toLowerCase();
            if (q.length < 2) return;
            const res = await fetch(`${API}/users`);
            const users = await res.json();
            const filtered = users.filter(u => u.tfid.toLowerCase().includes(q) || u.nom.toLowerCase().includes(q));
            const results = document.getElementById('search-results');
            results.innerHTML = '';
            filtered.forEach(u => {
                const div = document.createElement('div');
                div.className = "contact-card";
                div.innerHTML = `<div class="avatar">${u.nom[0]}</div><div><p class="font-bold">${u.prenom} ${u.nom}</p></div>`;
                div.onclick = () => openChat(u);
                results.appendChild(div);
            });
        }

        function openChat(peer) {
            activePeer = peer;
            document.getElementById('chat-peer-name').innerText = `${peer.prenom} ${peer.nom}`;
            document.getElementById('chat-peer-tfid').innerText = peer.tfid;
            navTo('scr-chat');
            fetchMessages();
            chatInterval = setInterval(fetchMessages, 3000);
        }

        async function fetchMessages() {
            if (!activePeer) return;
            try {
                const res = await fetch(`${API}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user1_tfid: user.tfid, user2_tfid: activePeer.tfid })
                });
                const messages = await res.json();
                const container = document.getElementById('chat-messages');
                container.innerHTML = '';
                messages.forEach(m => {
                    const div = document.createElement('div');
                    div.className = `bubble ${m.from === user.tfid ? 'me' : 'them'}`;
                    div.innerText = m.text;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            } catch (e) { console.error(e); }
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !activePeer) return;
            input.value = '';
            await fetch(`${API}/send`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sender_tfid: user.tfid, receiver_tfid: activePeer.tfid, message: text })
            });
            fetchMessages();
        }

        async function setupPush() {
            if ('serviceWorker' in navigator) {
                const reg = await navigator.serviceWorker.register('/sw.js');
                const sub = await reg.pushManager.getSubscription() || await reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: 'BFbcgVOdhydPHrXNgaelinKRIj4wUqTzLi13smhuzuzlWE_0F0evS2UxPm3fu-_gdVwNc5o3ursVFTKayf1Mndc'
                });
                await fetch(`${API}/subscribe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tfid: user.tfid, subscription: sub })
                });
            }
        }

        function startApp() {
            document.getElementById('m-name').innerText = `${user.prenom} ${user.nom}`;
            document.getElementById('m-tfid').innerText = user.tfid;
            document.getElementById('m-init').innerText = user.nom[0];
            navTo('scr-home');
            setupPush().catch(console.error);
        }

        function toggleAuth() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('reg-form').classList.toggle('hidden');
        }

        function logout() { localStorage.clear(); location.reload(); }

        if (user) startApp();
        else navTo('scr-auth');
    </script>
</body>
</html>
